<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Padel Manager</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Padel Manager">

<style>
:root{--blue:#0a84ff;--bg:#000000;--card:#1c1c1e;--muted:#9a9a9a;--green:#30d158;--red:#ff453a}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;margin:0;padding:12px;background:var(--bg);color:#ffffff}
h1{text-align:center;font-size:20px;margin:8px 0}
.card{background:var(--card);border-radius:14px;padding:12px;margin-bottom:12px;box-shadow:0 4px 10px rgba(0,0,0,.6)}
.compact{padding:6px}
label{font-size:13px;color:var(--muted)}
input,button{width:100%;padding:10px;font-size:15px;border-radius:10px;border:1px solid #ccc;box-sizing:border-box}
button{background:var(--blue);color:#fff;border:none;font-weight:600}
button.ghost{background:#eee;color:#000}
.row{display:flex;gap:8px}
.row>*{flex:1}
.list{font-size:14px}
.player{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #eee}
.badge{font-size:12px;margin-left:6px}
.green{color:var(--green)}
.red{color:var(--red)}
.match{border-top:1px solid #eee;padding-top:6px;margin-top:6px}
canvas{width:100%;height:240px}
</style>
</head>
<body>
<h1>üéæ Padel Manager</h1>

<!-- Spillere -->
<div class="card compact">
<h2 style="font-size:15px;margin:0">Spillere</h2>
<input id="newPlayer" placeholder="Skriv navn og tryk Enter" />
<div id="playerList" class="list"></div>
</div>

<!-- Dato & dagens spillere -->
<div class="card">
<h2 style="font-size:15px;margin:0">Kampdag</h2>
<label>Dato</label>
<input type="date" id="matchDate" />
<div id="todayPlayers" class="list"></div>
<button id="makeTeamsBtn" class="ghost">Lav hold</button>
</div>

<!-- Kamp -->
<div class="card">
<h2 style="font-size:15px;margin:0">Aktuel kamp</h2>
<div id="teams"></div>
<div class="row">
<input id="scoreA" placeholder="Hold A" inputmode="numeric" />
<input id="scoreB" placeholder="Hold B" inputmode="numeric" />
</div>
<div class="row" style="margin-top:6px">
<button id="saveMatchBtn">Gem kamp</button>
<button id="cancelLastBtn" class="ghost">Annuller sidste</button>
</div>
</div>

<!-- Rangliste -->
<div class="card">
<h2 style="font-size:15px;margin:0">üèÜ Rangliste</h2>
<div id="leaderboard" class="list"></div>
<canvas id="eloChart"></canvas>
</div>

<!-- Dagens kampe -->
<div class="card">
<h2 style="font-size:15px;margin:0">Dagens kampe</h2>
<div id="todayMatches" class="list"></div>
</div>

<!-- Historik -->
<div class="card">
<h2 style="font-size:15px;margin:0">Historik</h2>
<div id="history" class="list"></div>
<div class="row" style="margin-top:6px">
<button id="resetHistoryBtn" class="ghost">Nulstil historik</button>
<button id="resetAllBtn" class="ghost">Nulstil alt</button>
</div>
</div>

<script>
/**********************
 * STATE & STORAGE
 **********************/
const K = 32;
const STORAGE = 'padel-manager-v2';

let state = JSON.parse(localStorage.getItem(STORAGE)) || {
  players: [], // {name, elo, history: [elo...]}
  matches: []  // newest first
};

let rotationQueue = [];
let currentTeams = null;

const $ = id => document.getElementById(id);

function save(){ localStorage.setItem(STORAGE, JSON.stringify(state)); }

/**********************
 * PLAYER MANAGEMENT
 **********************/
function addPlayer(name){
  if(state.players.find(p=>p.name.toLowerCase()===name.toLowerCase())) return;
  state.players.push({ name, elo:1500, history:[1500] });
  save(); renderAll();
}

function deletePlayer(idx){
  if(!confirm('Slet spiller og alle kampe?')) return;
  const name = state.players[idx].name;
  state.players.splice(idx,1);
  state.matches = state.matches.filter(m=>!m.players.includes(name));
  recomputeAll();
}

/**********************
 * TEAM & ROTATION
 **********************/
function makeTeams(){
  const selected = [...document.querySelectorAll('#todayPlayers input:checked')]
    .map(cb=>state.players[cb.dataset.i]);
  if(selected.length < 4) return alert('V√¶lg mindst 4 spillere');

  if(selected.length > 4){
    if(rotationQueue.length === 0) rotationQueue = [...selected.map(p=>p.name)];
    const four = rotationQueue.splice(0,4);
    rotationQueue.push(...four);
    selected.splice(0,selected.length, ...four.map(n=>state.players.find(p=>p.name===n)));
  }

  currentTeams = {
    A: [selected[0], selected[1]],
    B: [selected[2], selected[3]]
  };

  $('teams').innerHTML = `Hold A: ${currentTeams.A.map(p=>p.name).join(' & ')}<br>Hold B: ${currentTeams.B.map(p=>p.name).join(' & ')}`;
}

/**********************
 * MATCH & ELO
 **********************/
function validScore(a,b){
  return (a===6 && b<=4) || (b===6 && a<=4) || (a===7 && (b===5||b===6)) || (b===7 && (a===5||a===6));
}

function finishMatch(){
  if(!currentTeams) return alert('Lav hold f√∏rst');
  const a = parseInt(scoreA.value), b = parseInt(scoreB.value);
  if(!validScore(a,b)) return alert('Ugyldigt resultat');

  state.matches.unshift({
    date: $('matchDate').value || new Date().toISOString().slice(0,10),
    teamA: currentTeams.A.map(p=>p.name),
    teamB: currentTeams.B.map(p=>p.name),
    scoreA:a, scoreB:b,
    players:[...currentTeams.A.map(p=>p.name),...currentTeams.B.map(p=>p.name)]
  });

  recomputeAll();
  scoreA.value=''; scoreB.value=''; currentTeams=null;
}

function recomputeAll(){
  state.players.forEach(p=>{p.elo=1500; p.history=[1500];});

  const chronological = [...state.matches].reverse();
  chronological.forEach(m=>{
    const pa = m.teamA.map(n=>state.players.find(p=>p.name===n));
    const pb = m.teamB.map(n=>state.players.find(p=>p.name===n));
    if(pa.includes(undefined) || pb.includes(undefined)) return;

    const avgA=(pa[0].elo+pa[1].elo)/2;
    const avgB=(pb[0].elo+pb[1].elo)/2;
    const expA=1/(1+10**((avgB-avgA)/400));
    const resA=m.scoreA>m.scoreB?1:0;
    const diff=m.scoreA-m.scoreB;
    const delta=Math.round(K*((resA-expA)+(diff/6)));

    pa.forEach(p=>{p.elo+=delta; p.history.push(p.elo);});
    pb.forEach(p=>{p.elo-=delta; p.history.push(p.elo);});
  });

  save(); renderAll();
}

/**********************
 * RENDERING
 **********************/
function renderPlayers(){
  $('playerList').innerHTML = state.players.map((p,i)=>
    `<div class='player'>${p.name}<span>${p.elo} <button onclick='deletePlayer(${i})'>‚úï</button></span></div>`
  ).join('');
}

function renderTodayPlayers(){
  $('todayPlayers').innerHTML = state.players.map((p,i)=>
    `<label><input type='checkbox' data-i='${i}'> ${p.name}</label>`
  ).join('<br>');
}

function renderLeaderboard(){
  const sorted=[...state.players].sort((a,b)=>b.elo-a.elo);
  $('leaderboard').innerHTML = sorted.map((p,i)=>{
    const last = p.history[p.history.length-1]-p.history[p.history.length-2]||0;
    return `${i+1}. ${p.name} ‚Äì ${p.elo} <span class='badge ${last>=0?'green':'red'}'>${last>0?'+':''}${last}</span>`;
  }).join('<br>');
}

function renderHistory(){
  $('history').innerHTML = state.matches.map((m,i)=>
    `<div class='match'>${m.date}: ${m.teamA.join(' & ')} ${m.scoreA}-${m.scoreB} ${m.teamB.join(' & ')} <button onclick='cancelMatch(${i})'>Annuller</button></div>`
  ).join('');
}

function renderTodayMatches(){
  const d=$('matchDate').value;
  const list=state.matches.filter(m=>m.date===d);
  $('todayMatches').innerHTML=list.length?list.map(m=>`${m.scoreA}-${m.scoreB}`).join('<br>'):'<em>Ingen kampe i dag</em>';
}

function cancelMatch(i){ if(confirm('Annuller kamp?')){ state.matches.splice(i,1); recomputeAll(); } }

/**********************
 * GRAPH (CANVAS)
 **********************/
function drawChart(){
  const c=$('eloChart');
  const ctx=c.getContext('2d');
  const dpr=window.devicePixelRatio||1;
  c.width=c.clientWidth*dpr; c.height=240*dpr; ctx.scale(dpr,dpr);
  ctx.clearRect(0,0,c.clientWidth,240);

  const players=state.players;
  if(players.length===0) return;

  const max=Math.max(...players.flatMap(p=>p.history))+20;
  const min=Math.min(...players.flatMap(p=>p.history))-20;

  const w=c.clientWidth-40, h=200;

  players.forEach(p=>{
    ctx.beginPath();
    ctx.strokeStyle=randomColor(p.name); ctx.lineWidth=2;
    p.history.forEach((v,i)=>{
      const x=20+(i/(p.history.length-1||1))*w;
      const y=20+((max-v)/(max-min))*h;
      i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
    });
    ctx.stroke();
  });
}

function randomColor(name){
  let hash=0; for(let i=0;i<name.length;i++) hash=name.charCodeAt(i)+((hash<<5)-hash);
  return `hsl(${hash%360},70%,50%)`;
}

function renderAll(){ renderPlayers(); renderTodayPlayers(); renderLeaderboard(); renderHistory(); renderTodayMatches(); drawChart(); }

/**********************
 * EVENTS
 **********************/
$('newPlayer').addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); addPlayer(e.target.value.trim()); e.target.value=''; } });
$('makeTeamsBtn').onclick=makeTeams;
$('saveMatchBtn').onclick=finishMatch;
$('cancelLastBtn').onclick=()=>state.matches.length&&cancelMatch(0);
$('resetHistoryBtn').onclick=()=>{ if(confirm('Nulstil historik?')){ state.matches=[]; recomputeAll(); } };
$('resetAllBtn').onclick=()=>{ if(confirm('Nulstil alt?')){ state={players:[],matches:[]}; save(); renderAll(); } };

renderAll();
</script>
</body>
</html>
