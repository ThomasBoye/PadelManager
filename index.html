<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8">
<title>Padel Manager</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI"; margin:0; padding:12px; background:#f2f2f7; }
h1,h2,h3 { text-align:center; margin:8px 0; }
.card { background:#fff; border-radius:16px; padding:12px; margin-bottom:14px; box-shadow:0 4px 10px rgba(0,0,0,.08); }
input { width:100%; padding:8px; font-size:14px; border-radius:10px; border:1px solid #ccc; }
button { width:100%; padding:10px; font-size:14px; border:none; border-radius:12px; background:#007aff; color:#fff; margin-top:4px; }
button.secondary { background:#e5e5ea; color:#000; }
.row { display:flex; gap:8px; }
.row > * { flex:1; }
label { font-size:12px; color:#666; }
.list { font-size:13px; }
.match { border-top:1px solid #eee; padding-top:8px; margin-top:8px; }
.elo-plus { color:green; }
.elo-minus { color:red; }
</style>
</head>
<body>

<h1>Padel Manager</h1>

<div class="card" style="padding:6px;">
<h2 style="font-size:16px; margin-bottom:6px;">1Ô∏è‚É£ Spillere</h2>
<input id="newPlayer" placeholder="Skriv navn og tryk Enter" />
<div id="playerList" class="list"></div>
</div>

<div class="card">
<h2>2Ô∏è‚É£ Dato & dagens spillere</h2>
<label>Dato</label>
<input type="date" id="matchDate" />
<div id="todayPlayers" class="list"></div>
<button class="secondary" type="button" id="makeTeamsBtn">Lav hold</button>
</div>

<div class="card">
<h2>3Ô∏è‚É£ Kamp</h2>
<p><strong id="teamA"></strong></p>
<p><strong id="teamB"></strong></p>
<label>Resultat (fx 6-4)</label>
<div class="row">
<input id="scoreA" placeholder="Hold A" />
<input id="scoreB" placeholder="Hold B" />
</div>
<button type="button" id="saveMatchBtn">Gem kamp</button>
<button class="secondary" type="button" id="cancelLastMatchBtn">Annuller sidste kamp</button>
</div>

<div class="card">
<h2>üèÜ Rangliste</h2>
<div id="leaderboard"></div>
<canvas id="eloChart" height="200"></canvas>
</div>

<div class="card">
<h2>üìú Historik</h2>
<div id="history"></div>
<button class="secondary" type="button" id="resetHistoryBtn">Nulstil historik</button>
</div>

<script>
const K = 32;
let players = JSON.parse(localStorage.getItem('players')||'[]');
let history = JSON.parse(localStorage.getItem('matchHistory')||'[]');
let teamA=[], teamB=[];
let eloChart;

function save(){
  localStorage.setItem('players', JSON.stringify(players));
  localStorage.setItem('matchHistory', JSON.stringify(history));
}

function $(id){return document.getElementById(id);}

function renderPlayers(){
  $('playerList').innerHTML = players.map((p,i)=>`${p.name} (${p.elo}) <button onclick='deletePlayer(${i})'>Slet</button>`).join('<br>');
  $('todayPlayers').innerHTML = players.map((p,i)=>`<label><input type='checkbox' data-i='${i}'> ${p.name}</label>`).join('<br>');
  renderLeaderboard();
  renderChart();
}

function deletePlayer(i){
  if(confirm(`Slet spilleren ${players[i].name}?`)){
    players.splice(i,1);
    save();
    renderPlayers();
  }
}

function renderLeaderboard(){
  const lb = players.slice().sort((a,b)=>b.elo-a.elo);
  $('leaderboard').innerHTML = lb.map((p,i)=>`${i+1}. ${p.name} ‚Äì ${p.elo}`).join('<br>');
}

function renderChart(){
  const labels = history.map(h=>h.date).reverse();
  const datasets = players.map(p=>{
    const data = history.map(h=>{
      const player = [...h.teamA,...h.teamB].find(pl=>pl.name===p.name);
      return player ? player.elo : null;
    }).reverse();
    return { label: p.name, data, fill:false, borderColor:randomColor(), tension:0.3 };
  });
  if(eloChart) eloChart.destroy();
  const ctx = $('eloChart').getContext('2d');
  eloChart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: { responsive:true, interaction:{mode:'index', intersect:false}, plugins:{legend:{position:'top'}}, scales:{y:{beginAtZero:true}}}
  });
}

function randomColor(){
  const r=Math.floor(Math.random()*200)+30;
  const g=Math.floor(Math.random()*200)+30;
  const b=Math.floor(Math.random()*200)+30;
  return `rgb(${r},${g},${b})`;
}

function renderHistory(){
  $('history').innerHTML = history.length ? history.map((h,i)=>`<div class='match'><strong>${h.date}</strong><br>${h.teamA.map(p=>p.name).join(' & ')} vs ${h.teamB.map(p=>p.name).join(' & ')}<br>Resultat: ${h.score}<br>${[...h.teamA,...h.teamB].map(p=>`${p.name}: <span class='${p.delta>=0?'elo-plus':'elo-minus'}'>${p.delta>=0?'+':''}${p.delta}</span>`).join('<br>')}<br><button onclick='cancelMatch(${i})'>Annuller denne kamp</button></div>`).join('') : '<em>Ingen kampe endnu</em>';
}

function addPlayer(){
  const name = $('newPlayer').value.trim();
  if(!name) return;
  players.push({name, elo:1500});
  $('newPlayer').value = '';
  save(); renderPlayers();
}

function makeTeams(){
  const checked = [...document.querySelectorAll('#todayPlayers input:checked')].map(c=>players[c.dataset.i]);
  if(checked.length<4) return alert('V√¶lg mindst 4 spillere');
  teamA=[checked[0],checked[1]];
  teamB=[checked[2],checked[3]];
  $('teamA').innerText='Hold A: '+teamA.map(p=>p.name).join(' & ');
  $('teamB').innerText='Hold B: '+teamB.map(p=>p.name).join(' & ');
}

function finishMatch(){
  const a=parseInt($('scoreA').value), b=parseInt($('scoreB').value);
  if(isNaN(a)||isNaN(b)) return alert('Ugyldigt resultat');
  const avgA=(teamA[0].elo+teamA[1].elo)/2;
  const avgB=(teamB[0].elo+teamB[1].elo)/2;
  const expA=1/(1+10**((avgB-avgA)/400));
  const resA=a>b?1:0;
  const diff=a-b;
  teamA.forEach(p=>p.delta=Math.round(K*((resA-expA)+(diff/6))));
  teamB.forEach(p=>p.delta=-teamA[0].delta);
  teamA.forEach(p=>p.elo+=p.delta);
  teamB.forEach(p=>p.elo+=p.delta);
  history.unshift({date:$('matchDate').value||new Date().toISOString().slice(0,10), teamA:[...teamA], teamB:[...teamB], score:`${a}-${b}`});
  save(); renderPlayers(); renderHistory();
}

function cancelMatch(index){
  if(confirm('Er du sikker p√•, du vil annullere denne kamp?')){
    const match = history.splice(index,1)[0];
    // Revert ELO
    match.teamA.forEach(p => { const pl = players.find(x=>x.name===p.name); if(pl) pl.elo -= p.delta; });
    match.teamB.forEach(p => { const pl = players.find(x=>x.name===p.name); if(pl) pl.elo -= p.delta; });
    save(); renderPlayers(); renderHistory();
  }
}

function resetHistory(){
  if(confirm('Vil du nulstille al historik?')){
    history=[];
    players.forEach(p=>p.elo=1500);
    save(); renderPlayers(); renderHistory();
  }
}

$('newPlayer').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); addPlayer(); } });
$('makeTeamsBtn').addEventListener('click', makeTeams);
$('saveMatchBtn').addEventListener('click', finishMatch);
$('cancelLastMatchBtn').addEventListener('click', ()=>{ if(history.length) cancelMatch(0); });
$('resetHistoryBtn').addEventListener('click', resetHistory);

renderPlayers(); renderHistory();
</script>
</body>
</html>
